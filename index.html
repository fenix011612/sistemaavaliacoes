<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Avaliações</title>

<style>
body{
  font-family: Arial, sans-serif;
  padding:20px;
  background:#f5f5f5;
}

h2{
  margin-bottom:10px;
}

input, select, textarea{
  padding:8px;
  margin:5px 0;
}

button{
  padding:6px 12px;
  cursor:pointer;
  margin-left:5px;
}

.card{
  background:white;
  padding:10px;
  margin:10px 0;
  border-radius:5px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
</style>

</head>
<body>

<h2>Sistema de Avaliações</h2>

<input type="text" id="nome" placeholder="Nome do paciente">
<select id="tipo">
  <option value="fisio">Fisio</option>
  <option value="pilates">Pilates</option>
  <option value="pelvica">Pélvica</option>
  <option value="recovery">Recovery</option>
</select>
<button onclick="salvar()">Salvar Avaliação</button>

<hr>

<button onclick="listar()">Listar Avaliações</button>

<div id="lista"></div>

<hr>

<div id="detalheAvaliacao"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  push, 
  set, 
  get 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAFNuEzaEvvpBKBGNG7NUf3zt74Q3r1fdo",
  authDomain: "sistemaavaliacoes-26513.firebaseapp.com",
  databaseURL: "https://sistemaavaliacoes-26513-default-rtdb.firebaseio.com",
  projectId: "sistemaavaliacoes-26513",
  storageBucket: "sistemaavaliacoes-26513.firebasestorage.app",
  messagingSenderId: "451297691104",
  appId: "1:451297691104:web:1f886ad169a54c4f8fd785"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.salvar = async function(){

  const nome = document.getElementById("nome").value;
  const tipo = document.getElementById("tipo").value;

  if(!nome){
    alert("Digite o nome!");
    return;
  }

  const novaRef = push(ref(db,"avaliacoes"));

  await set(novaRef,{
    nome,
    tipo,
    criadoEm: new Date().toLocaleString()
  });

  document.getElementById("nome").value="";
  listar();
}

window.listar = async function(){

  const lista = document.getElementById("lista");
  lista.innerHTML = "Carregando...";

  const snapshot = await get(ref(db,"avaliacoes"));

  if(!snapshot.exists()){
    lista.innerHTML = "Nenhuma avaliação encontrada.";
    return;
  }

  lista.innerHTML = "";

  snapshot.forEach(child=>{
    const dados = child.val();
    const id = child.key;

    lista.innerHTML += `
      <div class="card">
        <strong>${dados.nome}</strong><br>
        ${dados.tipo}<br>
        <small>${dados.criadoEm}</small><br><br>
        <button onclick="abrirAvaliacao('${id}')">Abrir</button>
      </div>
    `;
  });

}

window.abrirAvaliacao = async function(id){

  const detalhe = document.getElementById("detalheAvaliacao");
  detalhe.innerHTML = "Carregando...";

  const snapshot = await get(ref(db,"avaliacoes/"+id));
  const dados = snapshot.val();

  detalhe.innerHTML = `
    <h3>${dados.nome} (${dados.tipo})</h3>
    <p><small>Criado em: ${dados.criadoEm}</small></p>

    <h4>Nova Evolução</h4>
    <textarea id="textoEvolucao" rows="6" style="width:100%;"></textarea>
    <br><br>
    <button onclick="salvarEvolucao('${id}')">Salvar Evolução</button>

    <h4>Histórico</h4>
    <div id="historico"></div>
  `;

  carregarEvolucoes(id);
}

window.salvarEvolucao = async function(id){

  const texto = document.getElementById("textoEvolucao").value;

  if(!texto){
    alert("Digite a evolução.");
    return;
  }

  const novaRef = push(ref(db,"avaliacoes/"+id+"/evolucoes"));

  await set(novaRef,{
    data: new Date().toLocaleString(),
    texto
  });

  document.getElementById("textoEvolucao").value="";
  carregarEvolucoes(id);
}

async function carregarEvolucoes(id){

  const historico = document.getElementById("historico");

  const snapshot = await get(ref(db,"avaliacoes/"+id+"/evolucoes"));

  if(!snapshot.exists()){
    historico.innerHTML = "Nenhuma evolução registrada.";
    return;
  }

  historico.innerHTML = "";

  snapshot.forEach(child=>{
    const dados = child.val();

    historico.innerHTML += `
      <div class="card">
        <strong>DATA:</strong> ${dados.data}<br><br>
        ${dados.texto}
      </div>
    `;
  });

}

</script>

</body>
</html>
